<!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>MinecraftJS</title>
  <link rel="icon" href="assets/images/favicon.png">
  <link href="styles/game.css" rel="stylesheet">
  <script type="text/javascript" src="js/Game.js"></script>
  <script type="text/javascript" src="js/textures.js"></script>
  <script type="text/javascript" src="js/world.js"></script>
  <script type="text/javascript" src="js/world-structures.js"></script>
  <script type="text/javascript" src="js/randomizer.js"></script>
  <script type="text/javascript" src="js/Player.js"></script>
  <script type="text/javascript">
  		// Spritesheet
		var spriteSheetWidth = 256; // TODO : récupérer witdh image
		var spriteSheetHeight = 256;
		var spriteSheetCols = 16;
		var spriteSheetRows = 16;
		var worldCols = 40;
		var worldRows = 32; 
		var ctx;
		var canvas;
		var textureTilesheetImg = new Image();
		var sonicTilesheetImg = new Image();

		// Sprite
		var spriteWidth = (spriteSheetWidth / spriteSheetCols);
		var spriteHeight = (spriteSheetHeight / spriteSheetRows);

		// Layers of the world
		const SKY_LAYER = 5;
		const GRASS_LAYER = 6;
		const DIRT_LAYER = 8;
		const STONE_OR_DIRT_LAYER = 13;
		const STONE_LAYER = 32;
		const DIAMOND_LAYER = 37;
		const STONE_OR_BEDROCK_LAYER = 39;
		const BEDROCK_LAYER = 40;

		// Player
		var Player;
		const PLAYER_SPEED_WALK = 2;

		// Control
		var keyState = {IS_LEFT: false}; 
		const LEFT_ARROW_KEY = 37;
		const LEFT_Q_KEY = 81;
		const RIGHT_ARROW_KEY = 39;
		const RIGHT_D_ARROW_KEY = 68;
		const UP_ARROW = 38;
		const UP_SPACEBAR = 32;
		const IS_LEFT = 'is_left';

		// fps
		var fps, fpsId;
		const times = [];

		// Bored Animation
		var isNotMoving = true;
		var timeOfLastMove = 0;



		/*
			TODO : idées pour le jeu
			- sonic saute et peut casser des cubes lorsqu'il saute et se met en boule
			- plateforme se détruit aléatoirement et le but est de rester le plus longtemps possible en vie
			- timer et sonic doit descendre le plus vite possible chercher diamant/ring et le ramener dans un coffre
			- scrolling horizontal et sonic doit sauter de plaforme en plateforme pour rester en vie
		*/
		function initializeLevel() {
			canvas = document.getElementById("canvas");
			// set focus on canvas so eventListener is triggered whithout clicking on the canvas
			canvas.focus();

			// movement
			canvas.addEventListener('keydown', function(e) {
			    keyState[e.keyCode || e.which] = true; // keyCode and which are legacy and should be replaced by code
			    keyState[IS_LEFT] =  e.keyCode == LEFT_ARROW_KEY || e.keyCode == LEFT_Q_KEY;
			}, true);    
			canvas.addEventListener('keyup', function(e) {
			    keyState[e.keyCode || e.which] = false;
			}, true);

		    if (canvas.getContext) {
		    	ctx = canvas.getContext("2d");
		    	ctx.imageSmoothingEnabled = false; // remove unexpected space between tiles
		    	ctx.scale(3, 3); // zoom x3

		    	// creation of the player (sonic)
				Player = Object.create(Player);

				// load images
				textureTilesheetImg.src = "assets/images/texture.png";
				sonicTilesheetImg.src = "assets/images/sonic-tilesheet.png";

				// when texture image is ready, draw world
				textureTilesheetImg.onload = function () {
					drawWorld();
				}
				// start the gameloop
				gameLoop();
        	}
		}

		function gameLoop() {
			window.requestAnimationFrame(gameLoop);

			// TODO: set custom move() method in Player object, and call it in Player.update() method instead
			if (keyState[RIGHT_ARROW_KEY] || keyState[RIGHT_D_ARROW_KEY]) { // RIGHT
			    Player.walkAnimation.render(Player.posX+=PLAYER_SPEED_WALK);
			} else if (keyState[LEFT_ARROW_KEY] || keyState[LEFT_Q_KEY]) { // LEFT
				Player.walkAnimation.render(Player.posX-=PLAYER_SPEED_WALK, Player.posY, true);
			} else {
				if (isPlayerAway()) {
					Player.boredAnimation.render(Player.posX, Player.posY);
				} else {
					Player.idleAnimation.render(Player.posX, Player.posY, keyState[IS_LEFT]);
				}
			}

			refreshIsPlayerAway();

			// test jump animation
			if (keyState[UP_ARROW] || keyState[UP_SPACEBAR]) {
				//Player.rollAnimation.render(Player.posX, Player.posY);
				Player.jump();
			} else {
				Player.checkFalling();
			}

			Player.update();
			Player.render();

			// Calcul des FPS
			showFps();
		}
  </script>

</head>
<body onload="initializeLevel()">
	<div id="fps"></div>
	<div class="container">		
		<canvas width=1536 height=1920 class="sliding-background canvas-background"></canvas>
		<canvas id="canvas" width=1536 height=1920 class="canvas-game" tabindex="1"></canvas>
	</div>
</body>
</html>